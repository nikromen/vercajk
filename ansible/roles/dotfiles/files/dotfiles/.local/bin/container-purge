#!/usr/bin/env python3

from __future__ import annotations

import subprocess
from dataclasses import dataclass
from typing import Optional

import click


@dataclass
class PodmanObjectType:
    name: str
    list_cmd: list[str]
    delete_cmd: list[str]
    # this is only for images but whatever...
    display_format: Optional[str] = None


def run_command(cmd: list[str]) -> str:
    result = subprocess.run(
        cmd,
        stdout=subprocess.PIPE,
        stderr=subprocess.PIPE,
        text=True,
        check=False,
    )
    return result.stdout.strip()


def get_display_output(
    pattern: str, obj_type: PodmanObjectType, objects: list[str]
) -> str:
    if obj_type.display_format:
        return run_command(
            [
                "podman",
                "image",
                "ls",
                "-a",
                "--format",
                obj_type.display_format,
                "--filter",
                f"reference=*{pattern}*",
            ]
        )

    return "\n".join(objects)


def confirm_deletion(
    pattern: str, obj_type: PodmanObjectType, objects: list[str]
) -> bool:
    display = get_display_output(pattern, obj_type, objects)
    click.echo(f"\nThe following {obj_type.name} will be deleted:")
    click.echo(display)
    return click.confirm("\nContinue?", default=False)


def delete_objects_batch(
    objects: list[str],
    obj_type: PodmanObjectType,
    force: bool,
) -> None:
    for obj in objects:
        cmd = [*obj_type.delete_cmd]
        if force:
            cmd.append("--force")

        cmd.append(obj)

        result = subprocess.run(cmd, check=False, capture_output=True, text=True)
        if result.returncode == 0:
            click.echo(f"✓ Deleted {obj_type.name[:-1]}: {obj}")
        else:
            click.echo(f"✗ Failed to delete {obj_type.name[:-1]}: {obj}", err=True)


def process_object_type(
    pattern: str,
    obj_type: PodmanObjectType,
    force: bool,
) -> None:
    output = run_command(obj_type.list_cmd)
    if not output:
        click.echo(f"No {obj_type.name} found matching pattern: {pattern}")
        return

    objects = output.split()
    click.echo(f"\nFound {len(objects)} {obj_type.name} matching pattern: {pattern}")

    if confirm_deletion(pattern, obj_type, objects):
        delete_objects_batch(objects, obj_type, force)
    else:
        click.echo(f"Skipped {obj_type.name}")


def purge_by_pattern(pattern: str, force: bool) -> None:
    object_types = [
        PodmanObjectType(
            name="containers",
            list_cmd=["podman", "ps", "-qa", "--filter", f"name={pattern}"],
            delete_cmd=["podman", "rm"],
        ),
        PodmanObjectType(
            name="images",
            list_cmd=["podman", "image", "ls", "-qa", f"*{pattern}*"],
            delete_cmd=["podman", "image", "rm"],
            display_format="{{.Repository}}:{{.Tag}}    {{.ID}}",
        ),
        PodmanObjectType(
            name="volumes",
            list_cmd=["podman", "volume", "ls", "-q", "--filter", f"name={pattern}"],
            delete_cmd=["podman", "volume", "rm"],
        ),
        PodmanObjectType(
            name="networks",
            list_cmd=["podman", "network", "ls", "-q", "--filter", f"name={pattern}"],
            delete_cmd=["podman", "network", "rm"],
        ),
    ]

    for obj_type in object_types:
        process_object_type(pattern, obj_type, force)


def prune_all(force: bool) -> None:
    """Prune all unused Podman resources."""
    click.echo("Pruning all unused containers, images, volumes, and networks...")

    prune_commands = [
        ["podman", "system", "prune"],
        ["podman", "volume", "prune"],
        ["podman", "network", "prune"],
        ["podman", "image", "prune"],
    ]

    for cmd in prune_commands:
        if force:
            cmd.append("--force")
        subprocess.run(cmd, check=False)


@click.command(context_settings={"help_option_names": ["-h", "--help"]})
@click.option(
    "-f",
    "--force",
    is_flag=True,
    help="Force deletion without confirmation prompts",
)
@click.option(
    "--prune",
    is_flag=True,
    help="Prune all unused resources instead of matching by pattern",
)
@click.argument("pattern", required=False)
def main(force: bool, prune: bool, pattern: str | None) -> None:
    """Delete Podman containers, images, volumes, and networks matching PATTERN.

    \b
    Examples:
      container-purge myapp        # Delete all resources matching 'myapp'
      container-purge -f postgres  # Force delete postgres resources
      container-purge --prune      # Prune all unused resources
    """
    if prune:
        prune_all(force)
    elif pattern:
        purge_by_pattern(pattern, force)
    else:
        raise click.UsageError("Must specify PATTERN or use --prune")


if __name__ == "__main__":
    main()
